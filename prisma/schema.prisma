// SEO Auditor Database Schema
// Multi-tenant SaaS architecture with workspaces

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed password for email/password auth

  accounts      Account[]
  sessions      Session[]
  memberships   WorkspaceMember[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// WORKSPACE & TEAM MANAGEMENT
// ============================================================================

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  AGENCY
  ENTERPRISE
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      Plan     @default(FREE)

  members   WorkspaceMember[]
  sites     Site[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

model WorkspaceMember {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  role        Role      @default(MEMBER)

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
}

// ============================================================================
// SITE MANAGEMENT
// ============================================================================

model Site {
  id            String    @id @default(cuid())
  workspaceId   String
  url           String
  domain        String
  name          String?
  favicon       String?

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  audits        Audit[]
  keywords      Keyword[]
  integrations  Integration[]
  localListings LocalListing[]
  competitors   Competitor[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([workspaceId, domain])
  @@index([workspaceId])
  @@index([domain])
}

// ============================================================================
// AUDITS
// ============================================================================

enum AuditType {
  ON_PAGE
  TECHNICAL
  ACCESSIBILITY
  STRUCTURED_DATA
  FULL
}

enum AuditStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model Audit {
  id                String       @id @default(cuid())
  siteId            String
  url               String
  type              AuditType    @default(ON_PAGE)
  status            AuditStatus  @default(COMPLETED)
  score             Int

  // Structured audit data stored as JSON
  results           Json         // Full audit results
  onPageData        Json?        // Title, meta, H1, word count, links, images
  technicalData     Json?        // Lighthouse, Core Web Vitals, performance
  accessibilityData Json?        // WCAG compliance
  structuredData    Json?        // Schema.org validation

  site              Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([siteId])
  @@index([createdAt])
  @@index([siteId, createdAt])
}

// ============================================================================
// KEYWORD TRACKING & RANK MONITORING
// ============================================================================

enum Device {
  DESKTOP
  MOBILE
  TABLET
}

enum SearchIntent {
  INFORMATIONAL
  NAVIGATIONAL
  COMMERCIAL
  TRANSACTIONAL
}

model Keyword {
  id            String         @id @default(cuid())
  siteId        String
  keyword       String
  location      String         @default("United States")
  device        Device         @default(DESKTOP)

  // Keyword metrics
  searchVolume  Int?
  difficulty    Int?           // 0-100
  cpc           Float?
  intent        SearchIntent?
  targetUrl     String?

  site          Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  rankings      KeywordRanking[]
  serpFeatures  SerpFeature[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([siteId, keyword, location, device])
  @@index([siteId])
  @@index([keyword])
}

model KeywordRanking {
  id            String    @id @default(cuid())
  keywordId     String
  position      Int?      // null if not in top 100
  url           String?   // Ranking URL
  title         String?
  description   String?
  serpFeatures  String[]  // ["featured_snippet", "people_also_ask", "video"]

  keyword       Keyword   @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  date          DateTime  @default(now())

  @@index([keywordId, date])
  @@index([date])
}

enum SerpFeatureType {
  FEATURED_SNIPPET
  PEOPLE_ALSO_ASK
  KNOWLEDGE_PANEL
  LOCAL_PACK
  VIDEO
  IMAGE
  NEWS
  SHOPPING
  SITE_LINKS
}

model SerpFeature {
  id          String          @id @default(cuid())
  keywordId   String
  type        SerpFeatureType
  position    Int?
  content     Json            // Feature-specific data

  keyword     Keyword         @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  date        DateTime        @default(now())

  @@index([keywordId, date])
}

// ============================================================================
// LOCAL SEO
// ============================================================================

model LocalListing {
  id              String         @id @default(cuid())
  siteId          String
  businessName    String
  address         String
  city            String
  state           String
  zip             String
  country         String         @default("United States")
  phone           String?
  category        String
  website         String?

  site            Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  rankings        LocalRanking[]
  citations       Citation[]
  reviews         Review[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([siteId])
}

model LocalRanking {
  id              String        @id @default(cuid())
  listingId       String
  keyword         String
  position        Int?
  mapPosition     Int?          // Position in map pack (1-3)
  organicPosition Int?          // Position in organic results
  location        String        // "near [city, state]"

  listing         LocalListing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  date            DateTime      @default(now())

  @@index([listingId, date])
}

enum CitationStatus {
  ACTIVE
  INACTIVE
  INCONSISTENT
  PENDING
}

model Citation {
  id          String         @id @default(cuid())
  listingId   String
  source      String         // "Google", "Yelp", "Facebook", "Apple Maps"
  url         String?
  status      CitationStatus @default(ACTIVE)
  napMatch    Boolean        @default(true) // Name, Address, Phone match
  notes       String?

  listing     LocalListing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt   DateTime       @default(now())
  checkedAt   DateTime       @updatedAt

  @@index([listingId])
}

model Review {
  id          String        @id @default(cuid())
  listingId   String
  source      String        // "Google", "Yelp", "Facebook"
  rating      Float
  text        String?       @db.Text
  author      String?
  reviewDate  DateTime

  listing     LocalListing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())

  @@index([listingId])
  @@index([reviewDate])
}

// ============================================================================
// INTEGRATIONS
// ============================================================================

enum IntegrationType {
  GOOGLE_SEARCH_CONSOLE
  GOOGLE_ANALYTICS
  GOOGLE_BUSINESS_PROFILE
  GOOGLE_ADS
}

model Integration {
  id              String          @id @default(cuid())
  siteId          String
  type            IntegrationType
  credentials     Json            // Encrypted tokens/keys
  isActive        Boolean         @default(true)
  lastSyncAt      DateTime?

  site            Site            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([siteId, type])
  @@index([siteId])
}

// ============================================================================
// COMPETITOR ANALYSIS
// ============================================================================

model Competitor {
  id          String   @id @default(cuid())
  siteId      String
  domain      String
  name        String?

  site        Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([siteId, domain])
  @@index([siteId])
}
